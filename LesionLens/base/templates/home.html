{% extends 'main.html' %}
{% load static %}
{% block title %}Home | LesionLens{% endblock %}

{% block content %}
<div class="screen-1">
    <span>Diagnose with LesionLens</span>

    <form method="POST" enctype="multipart/form-data" style="display: contents;">
        {% csrf_token %}

        <!-- Email First -->
        <div class="form-group">
            <label for="patient-email">Email</label>
            <input type="email" id="patient-email" name="email" placeholder="Enter patient email" required>
        </div>

        <!-- Patient Name Second -->
        <div class="form-group">
            <label for="patient-name">Patient Name</label>
            <input type="text" id="patient-name" name="full_name" placeholder="Enter patient name" required>
        </div>

        <!-- Upload Box -->
        <div class="upload-container">
            <div class="upload-box" id="uploadBox">
                {% if annotated_url %}
                    <a href="{{ annotated_url }}" target="_blank">
                        <img id="previewImage" src="{{ annotated_url }}" alt="Annotated Result"
                            style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;">
                    </a>
                {% else %}
                    <p id="uploadText">Select an image for diagnosis</p>
                    <img id="previewImage"
                        style="display: none; width: 100%; height: 100%; object-fit: contain; border-radius: 6px;"
                        alt="Preview" />
                {% endif %}
                <input type="file" id="xray_image" name="xray_image" accept="image/*" style="display: none;" required>
            </div>
        </div>

        <!-- Error Message -->
        <div id="formError" style="color: red; font-weight: bold; margin-top: 10px;"></div>
        <button type="submit" class="add-patient" id="diagnoseBtn">Diagnose</button>
    </form>

    {% if class_name or confidence or inference_time %}
    <div class="result-container">
        {% if class_name %}<span>Class Name: {{ class_name }}</span>{% endif %}
        {% if confidence %}<span>Confidence: {{ confidence|floatformat:2 }}</span>{% endif %}
        {% if inference_time %}<span>Inference Time: {{ inference_time }} seconds</span>{% endif %}
    </div>
    {% endif %}
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const uploadBox = document.getElementById('uploadBox');
    const uploadText = document.getElementById('uploadText');
    const previewImage = document.getElementById('previewImage');
    const fileInput = document.getElementById('xray_image');

    {% if not annotated_url %}
    uploadBox.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                if (uploadText) uploadText.style.display = 'none';
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
    });
    {% endif %}
});
</script>

<!-- Autofill name by email -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const emailInput = document.getElementById('patient-email');
    const nameInput = document.getElementById('patient-name');

    emailInput.addEventListener('blur', function () {
        const email = emailInput.value;
        if (email) {
            fetch(`/ajax/get-patient-name/?email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.name) {
                        nameInput.value = data.name;
                    }
                });
        }
    });
});
</script>

<!-- Client-side validation -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form');
    const nameInput = document.getElementById('patient-name');
    const emailInput = document.getElementById('patient-email');
    const imageInput = document.getElementById('xray_image');
    const errorBox = document.getElementById('formError');

    form.addEventListener('submit', function (e) {
        errorBox.textContent = '';
        if (!emailInput.value.trim() || !nameInput.value.trim() || !imageInput.files.length) {
            e.preventDefault();
            if (!emailInput.value.trim()) errorBox.textContent += 'Please enter an email. ';
            if (!nameInput.value.trim()) errorBox.textContent += 'Please enter the patient name. ';
            if (!imageInput.files.length) errorBox.textContent += 'Please upload an image.';
        }
    });
});
</script>
{% endblock %}
